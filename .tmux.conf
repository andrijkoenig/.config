# Detect whether the current pane is running Vim/Neovim (or variants)
# Used later to decide whether to send keys to Vim or let tmux handle them
is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"

# Set terminal type for better color and feature support
set -g default-terminal "tmux-256color"

set -g default-shell /usr/bin/zsh
set -g default-command "/usr/bin/zsh -l"

# Enable true color (24-bit color) support
set -as terminal-overrides ",*:Tc"

# Fix cursor shape handling for Kitty terminal
set-option -ga terminal-overrides ',xterm-kitty:cnorm=\E[?12h\E[?25h'

# Remap tmux prefix key from Ctrl-b to Ctrl-a
unbind C-b
set-option -g prefix C-a
bind-key C-a send-prefix

# Start window numbering at 1 instead of 0
set -g base-index 1

# Place the tmux status bar at the top
set-option -g status-position top

# Use vi-style key bindings in status line and copy mode
set -g status-keys vi
set -g history-limit 10000
set -g mode-keys vi

# Disable activity monitoring and visual notifications
set -g monitor-activity off
set -g visual-activity off

# Disable audible bell actions
set-option -ga terminal-overrides ',*:cnorm=\E[?12h\E[?25h'
set-option -g bell-action none

# Keep tmux running even if the last session is destroyed
set -g detach-on-destroy off

# Enable mouse support (pane selection, resizing, scrolling)
set -g mouse on

# Sync tmux clipboard with system clipboard
set -g set-clipboard on

# Enable rendering of undercurls (used by some editors/themes)
set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'

# Enable colored underlines (used for diagnostics, spellcheck, etc.)
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'

# Window (tab) selection using Alt + number
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-6 select-window -t 6
bind -n M-7 select-window -t 7
bind -n M-8 select-window -t 8
bind -n M-9 select-window -t 9

# Pane and window management shortcuts
bind -n M-x kill-pane
bind -n M-X kill-window
bind -n M-t new-window
bind -n M-n new-session

# Rename window or session via prompt
bind -n M-r command-prompt -p "Rename window:" "rename-window '%%'"
bind -n M-R command-prompt -p "Rename session:" "rename-session '%%'"

# Split panes horizontally and vertically
bind -n 'M-\' split-window -h
bind -n 'M--' split-window -v

# Remove default split bindings
unbind '"'
unbind %

# Resize panes using Alt + Ctrl + hjkl
bind -n 'M-C-h' resize-pane -L 1
bind -n 'M-C-j' resize-pane -D 1
bind -n 'M-C-k' resize-pane -U 1
bind -n 'M-C-l' resize-pane -R 1

# Toggle pane zoom (maximize / restore)
bind -n 'M-z' resize-pane -Z

# Smart pane navigation:
# - If Vim is running, forward keys to Vim
# - Otherwise, move between tmux panes
bind-key -n 'M-h' if-shell "$is_vim" 'send-keys M-h' { if -F '#{pane_at_left}' '' 'select-pane -L' }
bind-key -n 'M-j' if-shell "$is_vim" 'send-keys M-j' { if -F '#{pane_at_bottom}' '' 'select-pane -D' }
bind-key -n 'M-k' if-shell "$is_vim" 'send-keys M-k' { if -F '#{pane_at_top}' '' 'select-pane -U' }
bind-key -n 'M-l' if-shell "$is_vim" 'send-keys M-l' { if -F '#{pane_at_right}' '' 'select-pane -R' }

# Pane navigation while in copy-mode (vi-style)
bind-key -T copy-mode-vi 'M-h' if -F '#{pane_at_left}' '' 'select-pane -L'
bind-key -T copy-mode-vi 'M-j' if -F '#{pane_at_bottom}' '' 'select-pane -D'
bind-key -T copy-mode-vi 'M-k' if -F '#{pane_at_top}' '' 'select-pane -U'
bind-key -T copy-mode-vi 'M-l' if -F '#{pane_at_right}' '' 'select-pane -R'

# Switch between windows
bind-key -n 'M-[' previous-window
bind-key -n 'M-]' next-window

# Reorder windows left/right and follow them
bind-key -n 'M-S-[' swap-window -t -1\; select-window -t -1
bind-key -n 'M-S-]' swap-window -t +1\; select-window -t +1

# Remove delay when pressing Escape (important for Vim users)
set -sg escape-time 0

# Reload tmux configuration
bind-key r source-file ~/.tmux.conf \; \
	display-message "Reloaded the config"

# Enable focus events (used by Vim/Neovim for better behavior)
set -g focus-events on

# Allow applications to passthrough escape sequences
set -g allow-passthrough all

# Load external colorscheme
color_bg="#171B20"
color_fg="#E7EAEE"
color_text="#171B20"
color_comment="#586172"
color_date="#5CCEFF"
color_time="#FFDB70"
color_alert="#F97791"
color_pomodoro="#F5335A"
color_session="#38FFA5"
color_window="#545c7e"

# Status bar base colors
set -g status-bg $color_bg
set -g status-fg $color_fg
set -g status-justify left

# Left side of status bar (session name)
set -g status-left-length 100
set -g status-left-style bg=$color_session,fg=$color_text,none
set -g status-left " #S "

# Right side of status bar (SSH or local indicator)
set -g status-right-style bg=$color_date,fg=$color_text,none
set -g status-right-length 102
set -g status-right " #{?#{pane_ssh_connected},#U @ #H#[default],local} "

# Window list formatting
set -g window-status-separator "ï‘„"
set -g window-status-format "  #W  "
set -g window-status-current-format "  #W  "

# Styling for active and inactive windows
set -g window-status-current-style fg=$color_fg,bg=$color_bg,bold
set -g window-status-style fg=$color_comment,bg=$color_bg,none

# Remove unused or conflicting key bindings
unbind-key m
unbind-key M
unbind-key M-m
unbind-key n
unbind-key p

# Session switcher using fzf
bind-key -n 'M-s' run-shell "select_tmux_session.sh"
